package com.razumly.mvp.core.data.dataTypes.dtos

import com.razumly.mvp.core.data.dataTypes.Event
import com.razumly.mvp.core.data.dataTypes.DivisionDetail
import com.razumly.mvp.core.data.dataTypes.enums.EventType
import com.razumly.mvp.core.data.util.mergeDivisionDetailsForDivisions
import com.razumly.mvp.core.data.util.normalizeDivisionIdentifiers
import kotlinx.serialization.Serializable
import kotlinx.serialization.Transient
import kotlin.time.Clock
import kotlin.time.ExperimentalTime
import kotlin.time.Instant

@Serializable
@OptIn(ExperimentalTime::class)
data class EventDTO(
    val name: String,
    val description: String = "",
    val doubleElimination: Boolean = false,
    val divisions: List<String> = emptyList(),
    val divisionDetails: List<DivisionDetail> = emptyList(),
    val winnerSetCount: Int = 1,
    val loserSetCount: Int = 0,
    val winnerBracketPointsToVictory: List<Int> = emptyList(),
    val loserBracketPointsToVictory: List<Int> = emptyList(),
    val prize: String = "",
    @Transient val id: String = "",
    val location: String = "",
    val start: String,
    val end: String,
    val priceCents: Int = 0,
    val rating: Double? = null,
    val imageId: String = "",
    val coordinates: List<Double> = listOf(0.0, 0.0),
    val hostId: String = "",
    val noFixedEndDateTime: Boolean = false,
    val maxParticipants: Int = 0,
    val minAge: Int? = null,
    val maxAge: Int? = null,
    val teamSizeLimit: Int = 2,
    val teamSignup: Boolean = true,
    val singleDivision: Boolean = true,
    val registrationByDivisionType: Boolean = false,
    val waitListIds: List<String> = emptyList(),
    val freeAgentIds: List<String> = emptyList(),
    val userIds: List<String> = emptyList(),
    val teamIds: List<String> = emptyList(),
    val cancellationRefundHours: Int = 0,
    val registrationCutoffHours: Int = 0,
    val seedColor: Int = 0,
    val sportId: String? = null,
    val timeSlotIds: List<String> = emptyList(),
    val fieldIds: List<String> = emptyList(),
    val leagueScoringConfigId: String? = null,
    val organizationId: String? = null,
    val autoCancellation: Boolean = false,
    val eventType: String = EventType.EVENT.name,
    val fieldCount: Int? = null,
    val gamesPerOpponent: Int? = null,
    val includePlayoffs: Boolean = false,
    val playoffTeamCount: Int? = null,
    val usesSets: Boolean = false,
    val matchDurationMinutes: Int? = null,
    val setDurationMinutes: Int? = null,
    val setsPerMatch: Int? = null,
    val doTeamsRef: Boolean? = null,
    val restTimeMinutes: Int? = null,
    val state: String = "UNPUBLISHED",
    val pointsToVictory: List<Int> = emptyList(),
    val refereeIds: List<String> = emptyList(),
    val allowPaymentPlans: Boolean? = null,
    val installmentCount: Int? = null,
    val installmentDueDates: List<String> = emptyList(),
    val installmentAmounts: List<Int> = emptyList(),
    val allowTeamSplitDefault: Boolean? = null,
    val requiredTemplateIds: List<String> = emptyList(),
) {
    fun toEvent(id: String): Event =
        Event(
            doubleElimination = doubleElimination,
            winnerSetCount = winnerSetCount,
            loserSetCount = loserSetCount,
            winnerBracketPointsToVictory = winnerBracketPointsToVictory,
            loserBracketPointsToVictory = loserBracketPointsToVictory,
            prize = prize,
            id = id,
            name = name,
            description = description,
            divisions = divisions.normalizeDivisionIdentifiers(),
            divisionDetails = mergeDivisionDetailsForDivisions(
                divisions = divisions,
                existingDetails = divisionDetails,
                eventId = id,
            ),
            location = location,
            start = Instant.parse(start),
            end = Instant.parse(end),
            priceCents = priceCents,
            rating = rating,
            imageId = imageId,
            coordinates = coordinates,
            hostId = hostId,
            noFixedEndDateTime = noFixedEndDateTime,
            teamSignup = teamSignup,
            singleDivision = singleDivision,
            freeAgentIds = freeAgentIds,
            waitListIds = waitListIds,
            userIds = userIds,
            teamIds = teamIds,
            cancellationRefundHours = cancellationRefundHours,
            registrationCutoffHours = registrationCutoffHours,
            seedColor = seedColor,
            sportId = sportId,
            timeSlotIds = timeSlotIds,
            fieldIds = fieldIds,
            leagueScoringConfigId = leagueScoringConfigId,
            organizationId = organizationId,
            autoCancellation = autoCancellation,
            maxParticipants = maxParticipants,
            minAge = minAge,
            maxAge = maxAge,
            teamSizeLimit = teamSizeLimit,
            registrationByDivisionType = registrationByDivisionType,
            eventType = EventType.valueOf(eventType),
            fieldCount = fieldCount,
            gamesPerOpponent = gamesPerOpponent,
            includePlayoffs = includePlayoffs,
            playoffTeamCount = playoffTeamCount,
            usesSets = usesSets,
            matchDurationMinutes = matchDurationMinutes,
            setDurationMinutes = setDurationMinutes,
            setsPerMatch = setsPerMatch,
            doTeamsRef = doTeamsRef,
            restTimeMinutes = restTimeMinutes,
            state = state,
            pointsToVictory = pointsToVictory,
            lastUpdated = Clock.System.now(),
            refereeIds = refereeIds,
            allowPaymentPlans = allowPaymentPlans,
            installmentCount = installmentCount,
            installmentDueDates = installmentDueDates,
            installmentAmounts = installmentAmounts,
            allowTeamSplitDefault = allowTeamSplitDefault,
            requiredTemplateIds = requiredTemplateIds,
        )
}
